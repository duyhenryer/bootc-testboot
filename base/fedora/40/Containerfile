# =============================================================================
# Base Image: Fedora bootc 40
# Layer 1: OS packages + production tuning (shared configs)
# =============================================================================
FROM quay.io/fedora/fedora-bootc:40

# --- System packages ---
RUN dnf install -y \
        htop curl jq lsof tcpdump sysstat vim-minimal \
        cloud-init openssh-server firewalld chrony \
    && dnf clean all \
    && rm -rf /var/cache/{dnf,ldconfig} /var/log/dnf*

# --- Production tuning (from base/shared/) ---
COPY base/shared/sysctl-tuning.conf   /usr/lib/sysctl.d/99-production.conf
COPY base/shared/systemd-limits.conf  /etc/systemd/system.conf.d/99-limits.conf
COPY base/shared/journald.conf        /etc/systemd/journald.conf.d/99-production.conf
COPY base/shared/sshd-hardening.conf  /etc/ssh/sshd_config.d/99-hardening.conf
COPY base/shared/chrony-custom.conf   /etc/chrony.d/99-custom.conf
COPY base/shared/base-tmpfiles.conf   /usr/lib/tmpfiles.d/base-production.conf
COPY base/shared/dhcpcd-sysusers.conf  /usr/lib/sysusers.d/dhcpcd.conf

# --- Firewall base rules ---
RUN firewall-offline-cmd --zone=public --add-port=22/tcp

# --- Base user ---
RUN useradd -r -m -d /var/home/appuser -s /bin/bash appuser && \
    usermod -aG wheel appuser

# --- Enable base services ---
RUN systemctl enable cloud-init sshd firewalld chronyd

# --- Validate ---
LABEL containers.bootc=1
