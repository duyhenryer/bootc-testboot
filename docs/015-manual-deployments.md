# Manual VM Deployments

Since we have moved to a **Pure Artifact Distribution** model, the CI pipeline no longer automatically uploads and registers virtual machine images with Cloud Providers (AWS, GCP, VMware). Instead, it generates the raw VM disks (`.ami`, `.qcow2`, `.vmdk`, etc.), packages them into OCI containers, and pushes them to GitHub Container Registry (GHCR).

This document explains how to "unpack" those artifacts and manually deploy them to your environment.

## 1. Extracting the Artifact

All generated disk formats are stored in `ghcr.io` as normal container images. You can use standard `podman` or `docker` commands to pull them.

For example, to get the `qcow2` image for `centos-stream9`:

```bash
# Pull the OCI artifact container
podman pull ghcr.io/duyhenryer/bootc-testboot-centos-stream9-qcow2:v3

# Create a temporary container
CONTAINER_ID=$(podman create ghcr.io/duyhenryer/bootc-testboot-centos-stream9-qcow2:v3)

# Extract the disk file from the container to your local filesystem
podman cp $CONTAINER_ID:/output/qcow2/disk.qcow2 ./my-disk.qcow2

# Cleanup
podman rm $CONTAINER_ID
```

*(Note: The internal path inside the container varies slightly depending on the format, e.g., `/output/qcow2/disk.qcow2`, `/output/vmdk/disk.vmdk`, or `/output/image.tar.gz` for GCE).*

---

## 2. Deploying to AWS EC2 (AMI)

The `ami` format generated by `bootc-image-builder` needs to be uploaded as an AWS Snapshot and registered as an AMI.

**Prerequisites:** AWS CLI configured with appropriate permissions.

```bash
# Extract the raw file (often disk.raw inside the AMI output) 
# and upload it to an S3 bucket
aws s3 cp ./disk.raw s3://my-bucket/bootc-disk.raw

# Use VM Import/Export to create a snapshot from the raw disk
aws ec2 import-snapshot --disk-container "Format=raw,UserBucket={S3Bucket=my-bucket,S3Key=bootc-disk.raw}"

# Wait for the snapshot to complete, then register it as an AMI
aws ec2 register-image \
    --name "bootc-custom-centos" \
    --architecture x86_64 --root-device-name /dev/xvda \
    --virtualization-type hvm \
    --block-device-mappings "DeviceName=/dev/xvda,Ebs={SnapshotId=snap-0123456789abcde}"
```

---

## 3. Deploying to Google Cloud Platform (GCE)

GCP requires a `.tar.gz` file containing exactly one file named `disk.raw`. Because our CI generates standard `raw` distributions inside an OCI container, you must pull the `raw` package, extract it, compress it correctly, and then upload it.

**Prerequisites:** `gcloud` CLI and `gsutil`.

```bash
# 1. Pull the raw artifact image
podman pull ghcr.io/duyhenryer/bootc-testboot-centos-stream9-raw:v3

# 2. Extract the raw disk using a dummy container
ctr=$(podman create ghcr.io/duyhenryer/bootc-testboot-centos-stream9-raw:v3 /bin/true)
podman cp $ctr:/image/disk.raw ./disk.raw
podman rm $ctr

# 3. Compress it into the exact tarball format Google expects
tar -Szcvf bootc-centos9.tar.gz disk.raw

# 4. Upload the tarball to Google Cloud Storage
gsutil cp ./bootc-centos9.tar.gz gs://my-gcp-bucket/bootc-centos9.tar.gz

# 5. Create a Custom GCE Image from the tarball
gcloud compute images create "bootc-centos9-custom-v3" \
    --project="my-project-id" \
    --source-uri="gs://my-gcp-bucket/bootc-centos9.tar.gz" \
    --guest-os-features=UEFI_COMPATIBLE,VIRTIO_SCSI_MULTIQUEUE \
    --description="Bootc OS Custom Image v3"

# 6. Create a VM Instance using the newly registered Image
gcloud compute instances create "vm-bootc-centos9-testing" \
    --project="my-project-id" \
    --zone="asia-southeast1-a" \
    --machine-type="e2-medium" \
    --image="bootc-centos9-custom-v3"
```

---

## 4. Deploying to VMware (VMDK / OVA)

VMware vSphere or ESXi uses `.vmdk` files, but it's often easier to package them into an `.ova` using VMware's `ovftool`.

**Prerequisites:** `ovftool` installed locally.

```bash
# Step 1: Create a basic .ovf descriptor template
cat <<EOF > template.ovf
<?xml version="1.0"?>
<Envelope xmlns="http://schemas.dmtf.org/ovf/envelope/1">
  <DiskSection>
    <Disk ovf:diskId="vmdisk1" ovf:capacity="20" ovf:capacityAllocationUnits="byte * 2^30" ovf:fileRef="disk.vmdk"/>
  </DiskSection>
  <!-- Basic Hardware config (CPU, RAM) goes here -->
</Envelope>
EOF

# Step 2: Use ovftool to bundle the .ovf and .vmdk into an OVA
ovftool ./template.ovf ./bootc-vmware.ova

# Step 3: Deploy the OVA
# You can now import the `bootc-vmware.ova` directly through the vSphere Web Client.
```

---

## 5. Bare Metal (Anaconda ISO)

The `anaconda-iso` format packages your Bootc system into a bootable ISO.

1. Extract the `.iso` file using the method in Step 1.
2. Flash it to a USB drive using Rufus (Windows) or `dd` (Linux/Mac):
   ```bash
   sudo dd if=./bootc-installer.iso of=/dev/sdX bs=4M status=progress
   ```
3. Boot the physical machine from the USB drive. The Anaconda installer will automatically lay down the Bootc image onto the hard drive. 
